pipeline {
  agent none

  environment {
    AWS_DEFAULT_REGION = 'us-east-1'
    AWS_REGION         = 'us-east-1'
    SAM_CLI_TELEMETRY  = '0'
  }

  options {
    timestamps()
    skipDefaultCheckout(true)
  }

  stages {

    // =========================
    // Checkout SIEMPRE en un agente (NO controller)
    // =========================
    stage('Get Code') {
      agent { label 'agent-static' }
      steps {
        checkout scm
        sh '''
          set -e
          echo "=== WHERE AM I? (Get Code) ==="
          whoami
          hostname
          echo "BRANCH_NAME=$BRANCH_NAME"
          git log -1 --oneline
        '''
        stash name: 'src', includes: '**/*'
      }
    }

    // =========================
    // CI (develop) - Static Test en agent-static
    // =========================
    stage('Static Test') {
      when { branch 'develop' }
      agent { label 'agent-static' }
      steps {
        unstash 'src'
        sh '''
          set -e
          echo "=== WHERE AM I? (Static Test) ==="
          whoami
          hostname

          python3 -m pip install --user --upgrade pip >/dev/null
          python3 -m pip install --user flake8 bandit >/dev/null

          mkdir -p reports

          # Flake8 solo /src -> informe (NO falla el stage si hay issues)
          python3 -m flake8 src --statistics --count --tee --output-file reports/flake8.txt || true
          test -s reports/flake8.txt || echo "No flake8 issues" > reports/flake8.txt

          # Bandit solo /src -> informe (NO falla el stage si hay issues)
          python3 -m bandit -r src -f txt -o reports/bandit.txt || true
          test -s reports/bandit.txt || echo "No bandit issues" > reports/bandit.txt

          echo "== Flake8 report (tail) =="
          tail -n 50 reports/flake8.txt || true
          echo "== Bandit report (tail) =="
          tail -n 50 reports/bandit.txt || true
        '''
      }
      post {
        always {
          archiveArtifacts artifacts: 'reports/*.txt', fingerprint: true
        }
      }
    }

    // =========================
    // Deploy (develop/master) en agent-rest
    // =========================
    stage('Deploy') {
      agent { label 'agent-rest' }
      steps {
        unstash 'src'
        sh '''
          set -eu
          echo "=== WHERE AM I? (Deploy) ==="
          whoami
          hostname

          # Elegir entorno por rama
          if [ "$BRANCH_NAME" = "develop" ]; then
            STACK_NAME="todo-list-staging"
            STAGE_PARAM="staging"
          elif [ "$BRANCH_NAME" = "master" ]; then
            STACK_NAME="todo-list-production"
            STAGE_PARAM="production"
          else
            echo "INFO: Rama $BRANCH_NAME sin despliegue (solo develop/master)."
            exit 0
          fi

          echo "=== Deploy stack: $STACK_NAME (Stage=$STAGE_PARAM) ==="

          sam build
          sam validate

          # Config mínimo para CI (evitar modo guiado)
          cat > samconfig-ci.toml <<EOF
version = 0.1
EOF

          # Evitar AlreadyExistsException por changeset samcli-deploy repetido
          echo "Cleaning old CloudFormation changesets for $STACK_NAME..."
          CHANGESETS=$(aws cloudformation list-change-sets \
            --stack-name "$STACK_NAME" \
            --region us-east-1 \
            --query "Summaries[?starts_with(ChangeSetName, 'samcli-deploy')].[ChangeSetName,Status]" \
            --output text 2>/dev/null || true)

          if [ -n "$CHANGESETS" ]; then
            echo "$CHANGESETS" | while read -r CS_NAME CS_STATUS; do
              case "$CS_STATUS" in
                CREATE_IN_PROGRESS|DELETE_IN_PROGRESS)
                  echo " - Skip (in progress): $CS_NAME ($CS_STATUS)"
                  ;;
                *)
                  echo " - Deleting: $CS_NAME ($CS_STATUS)"
                  aws cloudformation delete-change-set \
                    --stack-name "$STACK_NAME" \
                    --change-set-name "$CS_NAME" \
                    --region us-east-1 || true
                  ;;
              esac
            done
          else
            echo " - No samcli-deploy changesets found."
          fi

          sleep 2

          sam deploy \
            --stack-name "$STACK_NAME" \
            --resolve-s3 \
            --capabilities CAPABILITY_IAM \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --config-file samconfig-ci.toml \
            --parameter-overrides Stage="$STAGE_PARAM"
        '''
      }
    }

    // =========================
    // CI Rest Test (develop) - Pytest completo
    // =========================
    stage('Rest Test') {
      when { branch 'develop' }
      agent { label 'agent-rest' }
      steps {
        unstash 'src'
        sh '''
          set -e
          echo "=== WHERE AM I? (Rest Test) ==="
          whoami
          hostname

          STACK_NAME="todo-list-staging"

          # Obtener la URL del API desde CloudFormation
          BASE_URL=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --region us-east-1 \
            --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" \
            --output text)

          echo "BASE_URL=$BASE_URL"
          export BASE_URL

          python3 -m pip install --user -U pytest requests >/dev/null

          # Ejecutar pruebas de integración (si falla una, falla el pipeline)
          pytest -q test/integration/todoApiTest.py -m api
        '''
      }
    }

    // =========================
    // CD Rest Test (master) - SOLO LECTURA con curl
    // =========================
    stage('Rest Test (Read Only)') {
      when { branch 'master' }
      agent { label 'agent-rest' }
      steps {
        unstash 'src'
        sh '''
          set -eu
          echo "=== WHERE AM I? (Read Only) ==="
          whoami
          hostname

          STACK_NAME="todo-list-production"
          echo "=== Rest Test (READ-ONLY) ==="

          BASE_URL=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --region us-east-1 \
            --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" \
            --output text)

          if [ -z "$BASE_URL" ] || [ "$BASE_URL" = "None" ]; then
            echo "ERROR: No se pudo obtener BASE_URL"
            exit 1
          fi

          echo "BASE_URL=$BASE_URL"

          echo "---- curl: GET /todos ----"
          LIST_RESP=$(curl -sS -w "\\nHTTP_STATUS:%{http_code}\\n" "$BASE_URL/todos")
          echo "$LIST_RESP"

          LIST_STATUS=$(echo "$LIST_RESP" | sed -n 's/^HTTP_STATUS://p')
          LIST_BODY=$(echo "$LIST_RESP" | sed '/^HTTP_STATUS:/d')

          if [ "$LIST_STATUS" != "200" ]; then
            echo "ERROR: GET /todos devolvió HTTP $LIST_STATUS"
            exit 1
          fi

          TODO_ID=$(python3 -c 'import json,sys;
d=json.loads(sys.argv[1]);
print(d[0]["id"] if isinstance(d,list) and d and "id" in d[0] else "")' "$LIST_BODY")

          if [ -z "$TODO_ID" ]; then
            echo "INFO: No hay todos en producción. Listado OK (HTTP 200)."
            exit 0
          fi

          echo "---- curl: GET /todos/$TODO_ID ----"
          GET_RESP=$(curl -sS -w "\\nHTTP_STATUS:%{http_code}\\n" "$BASE_URL/todos/$TODO_ID")
          echo "$GET_RESP"

          GET_STATUS=$(echo "$GET_RESP" | sed -n 's/^HTTP_STATUS://p')
          if [ "$GET_STATUS" != "200" ]; then
            echo "ERROR: GET /todos/$TODO_ID devolvió HTTP $GET_STATUS"
            exit 1
          fi

          echo "INFO: Pruebas READ-ONLY completadas correctamente."
        '''
      }
    }

    // =========================
    // Promote solo en develop (merge develop -> master)
    // =========================
    stage('Promote') {
      when { branch 'develop' }
      agent { label 'agent-rest' } // o agent-static, pero que sea un AGENTE, no controller
      steps {
        unstash 'src'
        withCredentials([
          usernamePassword(
            credentialsId: 'github-pat',
            usernameVariable: 'GIT_USER',
            passwordVariable: 'GIT_TOKEN'
          )
        ]) {
          sh '''
            set -e
            echo "=== WHERE AM I? (Promote) ==="
            whoami
            hostname

            echo "=== Promote: merge develop -> master ==="

            git config user.email "jenkins@local"
            git config user.name "jenkins"

            # Asegurar refs
            git fetch origin --prune

            # Traer origin/master explícitamente
            git fetch origin master:refs/remotes/origin/master

            # Dejar master igual al remoto
            git checkout -B master refs/remotes/origin/master

            # Merge desde develop (remota)
            git merge --no-ff origin/develop -m "Promote: merge develop into master"

            # Push a master
            git push https://$GIT_USER:$GIT_TOKEN@github.com/Al3jandr00/todo-list-aws.git master

            echo "=== Promote completed successfully ==="
          '''
        }
      }
    }
  }
}
