pipeline {
  agent any

  environment {
    AWS_DEFAULT_REGION = 'us-east-1'
    AWS_REGION         = 'us-east-1'
    SAM_CLI_TELEMETRY  = '0'
  }

  options {
    timestamps()
    skipDefaultCheckout(true)
  }

  stages {

    // -------------------------
    // 1) Get Code (agente por defecto)
    //    + Reto 4: descarga samconfig.toml desde repo config (rama staging/production)
    // -------------------------
    stage('Get Code') {
      steps {
        checkout scm
        sh '''
          set -e
          echo "=== STAGE: Get Code ==="
          echo "=== RUNNING ON ==="
          echo "NODE_NAME=$NODE_NAME"
          echo "EXECUTOR_NUMBER=$EXECUTOR_NUMBER"
          whoami
          hostname
          pwd
          echo "=================="

          echo "BRANCH_NAME=$BRANCH_NAME"
          git log -1 --oneline

          # -------------------------
          # Reto 4: Config externa
          # - develop  -> rama staging
          # - master   -> rama production
          # -------------------------
          if [ "$BRANCH_NAME" = "develop" ]; then
            CONFIG_BRANCH="staging"
          elif [ "$BRANCH_NAME" = "master" ]; then
            CONFIG_BRANCH="production"
          else
            CONFIG_BRANCH=""
          fi

          if [ -n "$CONFIG_BRANCH" ]; then
            echo "Downloading samconfig.toml from todo-list-aws-config ($CONFIG_BRANCH)..."

            curl -sSLo samconfig.toml \
              "https://raw.githubusercontent.com/Al3jandr00/todo-list-aws-config/${CONFIG_BRANCH}/samconfig.toml"

            echo "Downloaded samconfig.toml:"
            ls -l samconfig.toml
            echo "---- samconfig.toml (head) ----"
            head -n 80 samconfig.toml || true
            echo "-------------------------------"
          else
            echo "INFO: Rama $BRANCH_NAME sin config externa (solo develop/master)."
          fi
        '''
        // Guardamos el workspace para reusarlo en los agentes
        stash name: 'repo', includes: '**', excludes: '.git/**'
      }
    }

    // -------------------------
    // 2) Static Test (agent-static)
    // -------------------------
    stage('Static Test') {
      when { branch 'develop' }
      agent { label 'agent-static' }
      steps {
        unstash 'repo'
        sh '''
          set -e
          echo "=== STAGE: Static Test ==="
          echo "=== RUNNING ON ==="
          echo "NODE_NAME=$NODE_NAME"
          echo "EXECUTOR_NUMBER=$EXECUTOR_NUMBER"
          whoami
          hostname
          pwd
          echo "=================="

          python3 -m pip install --user --upgrade pip >/dev/null
          python3 -m pip install --user flake8 bandit >/dev/null

          mkdir -p reports

          # Flake8 -> informe (no rompe build si hay issues)
          python3 -m flake8 src --statistics --count --tee --output-file reports/flake8.txt || true
          test -s reports/flake8.txt || echo "No flake8 issues" > reports/flake8.txt

          # Bandit -> informe (no rompe build si hay issues)
          python3 -m bandit -r src -f txt -o reports/bandit.txt || true
          test -s reports/bandit.txt || echo "No bandit issues" > reports/bandit.txt

          echo "== Flake8 report (tail) =="
          tail -n 50 reports/flake8.txt || true
          echo "== Bandit report (tail) =="
          tail -n 50 reports/bandit.txt || true
        '''
      }
      post {
        always {
          archiveArtifacts artifacts: 'reports/*.txt', fingerprint: true
        }
      }
    }

    // -------------------------
    // 3) Deploy (agente por defecto)
    //    + Reto 4: usar samconfig.toml descargado (repo externo)
    // -------------------------
    stage('Deploy') {
      steps {
        unstash 'repo'
        sh '''
          set -eu
          echo "=== STAGE: Deploy ==="
          echo "=== RUNNING ON ==="
          echo "NODE_NAME=$NODE_NAME"
          echo "EXECUTOR_NUMBER=$EXECUTOR_NUMBER"
          whoami
          hostname
          pwd
          echo "=================="

          # Elegir entorno por rama
          if [ "$BRANCH_NAME" = "develop" ]; then
            STACK_NAME="todo-list-staging"
          elif [ "$BRANCH_NAME" = "master" ]; then
            STACK_NAME="todo-list-production"
          else
            echo "INFO: Rama $BRANCH_NAME sin despliegue (solo develop/master)."
            exit 0
          fi

          # Reto 4: requerimos samconfig.toml en develop/master
          if [ ! -f samconfig.toml ]; then
            echo "ERROR: samconfig.toml no existe en el workspace. Revisa la descarga en 'Get Code'."
            exit 1
          fi

          echo "=== Deploy stack: $STACK_NAME (usando samconfig.toml) ==="
          echo "samconfig.toml (head):"
          head -n 40 samconfig.toml || true

          sam build
          sam validate

          # --- FIX: evitar AlreadyExistsException por changeset samcli-deploy repetido ---
          echo "Cleaning old CloudFormation changesets for $STACK_NAME..."
          CHANGESETS=$(aws cloudformation list-change-sets \
            --stack-name "$STACK_NAME" \
            --region us-east-1 \
            --query "Summaries[?starts_with(ChangeSetName, 'samcli-deploy')].[ChangeSetName,Status]" \
            --output text 2>/dev/null || true)

          if [ -n "$CHANGESETS" ]; then
            echo "$CHANGESETS" | while read -r CS_NAME CS_STATUS; do
              case "$CS_STATUS" in
                CREATE_IN_PROGRESS|DELETE_IN_PROGRESS)
                  echo " - Skip (in progress): $CS_NAME ($CS_STATUS)"
                  ;;
                *)
                  echo " - Deleting: $CS_NAME ($CS_STATUS)"
                  aws cloudformation delete-change-set \
                    --stack-name "$STACK_NAME" \
                    --change-set-name "$CS_NAME" \
                    --region us-east-1 || true
                  ;;
              esac
            done
          else
            echo " - No samcli-deploy changesets found."
          fi

          # peque침o delay por si hay builds muy seguidos
          sleep 2
          # ---------------------------------------------------------------------------

          # Reto 4: deploy con config externa
          sam deploy \
            --config-file samconfig.toml \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset
        '''
      }
    }

    // -------------------------
    // 4) Rest Test (develop) (agent-rest)
    // -------------------------
    stage('Rest Test') {
      when { branch 'develop' }
      agent { label 'agent-rest' }
      steps {
        unstash 'repo'
        sh '''
          set -e
          echo "=== STAGE: Rest Test (develop) ==="
          echo "=== RUNNING ON ==="
          echo "NODE_NAME=$NODE_NAME"
          echo "EXECUTOR_NUMBER=$EXECUTOR_NUMBER"
          whoami
          hostname
          pwd
          echo "=================="

          STACK_NAME="todo-list-staging"

          # El agente REST no "hereda" la URL del deploy -> la volvemos a leer de CloudFormation
          BASE_URL=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --region us-east-1 \
            --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" \
            --output text)

          echo "BASE_URL=$BASE_URL"
          export BASE_URL

          python3 -m pip install --user -U pytest requests >/dev/null
          pytest -q test/integration/todoApiTest.py -m api
        '''
      }
    }

    // -------------------------
    // 5) Rest Test (Read Only) (master) (agent-rest)
    // -------------------------
    stage('Rest Test (Read Only)') {
      when { branch 'master' }
      agent { label 'agent-rest' }
      steps {
        unstash 'repo'
        sh '''
          set -eu
          echo "=== STAGE: Rest Test (Read Only) (master) ==="
          echo "=== RUNNING ON ==="
          echo "NODE_NAME=$NODE_NAME"
          echo "EXECUTOR_NUMBER=$EXECUTOR_NUMBER"
          whoami
          hostname
          pwd
          echo "=================="

          STACK_NAME="todo-list-production"

          echo "=== Rest Test (READ-ONLY) ==="

          BASE_URL=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --region us-east-1 \
            --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" \
            --output text)

          if [ -z "$BASE_URL" ] || [ "$BASE_URL" = "None" ]; then
            echo "ERROR: No se pudo obtener BASE_URL"
            exit 1
          fi

          echo "BASE_URL=$BASE_URL"

          echo "---- curl: GET /todos ----"
          LIST_RESP=$(curl -sS -w "\\nHTTP_STATUS:%{http_code}\\n" "$BASE_URL/todos")

          echo "$LIST_RESP"

          LIST_STATUS=$(echo "$LIST_RESP" | sed -n 's/^HTTP_STATUS://p')
          LIST_BODY=$(echo "$LIST_RESP" | sed '/^HTTP_STATUS:/d')

          if [ "$LIST_STATUS" != "200" ]; then
            echo "ERROR: GET /todos devolvi칩 HTTP $LIST_STATUS"
            exit 1
          fi

          # Extraer un ID si existe alguno (sin jq, sin stdin)
          TODO_ID=$(python3 -c 'import json,sys;
d=json.loads(sys.argv[1]);
print(d[0]["id"] if isinstance(d,list) and d and "id" in d[0] else "")' "$LIST_BODY")

          if [ -z "$TODO_ID" ]; then
            echo "INFO: No hay todos en producci칩n. Prueba OK (listar = 200)."
            exit 0
          fi

          echo "---- curl: GET /todos/$TODO_ID ----"
          GET_RESP=$(curl -sS -w "\\nHTTP_STATUS:%{http_code}\\n" "$BASE_URL/todos/$TODO_ID")

          echo "$GET_RESP"

          GET_STATUS=$(echo "$GET_RESP" | sed -n 's/^HTTP_STATUS://p')

          if [ "$GET_STATUS" != "200" ]; then
            echo "ERROR: GET /todos/$TODO_ID devolvi칩 HTTP $GET_STATUS"
            exit 1
          fi

          echo "INFO: Pruebas READ-ONLY completadas correctamente."
        '''
      }
    }

    // -------------------------
    // 6) Promote (agente por defecto)
    // -------------------------
    stage('Promote') {
      when { branch 'develop' }
      steps {
        unstash 'repo'
        withCredentials([
          usernamePassword(
            credentialsId: 'github-pat',
            usernameVariable: 'GIT_USER',
            passwordVariable: 'GIT_TOKEN'
          )
        ]) {
          sh '''
            set -e
            echo "=== STAGE: Promote ==="
            echo "=== RUNNING ON ==="
            echo "NODE_NAME=$NODE_NAME"
            echo "EXECUTOR_NUMBER=$EXECUTOR_NUMBER"
            whoami
            hostname
            pwd
            echo "=================="

            echo "=== Promote: merge develop -> master ==="

            git config user.email "jenkins@local"
            git config user.name "jenkins"

            git fetch origin --prune
            git fetch origin master:refs/remotes/origin/master

            git checkout -B master refs/remotes/origin/master
            git merge --no-ff origin/develop -m "Promote: merge develop into master"

            git push https://$GIT_USER:$GIT_TOKEN@github.com/Al3jandr00/todo-list-aws.git master

            echo "=== Promote completed successfully ==="
          '''
        }
      }
    }
  }
}
